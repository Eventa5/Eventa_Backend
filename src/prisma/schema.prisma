generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma" // 維持預設產出位置
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ActivityStatus {
  draft
  published
  ended
  canceled
}

enum OrderStatus {
  PAID     @map("paid")
  PENDING  @map("pending")
  EXPIRED  @map("expired")
  CANCELED @map("canceled")
}

enum InvoiceType {
  B2C @map("b2c")
  B2B @map("b2b")
}

enum TicketStatus {
	USED @map("used")

}

model User {
  id           Int            @id @default(autoincrement())
  memberId     String         @unique
  email        String         @unique
  password     String?
  name         String?
  avatar       String?
  displayName  String?
  birthday     DateTime?
  gender       String?
  phoneNumber  String?
  countryCode  String?
  region       String?
  address      String?
  identity     String?
  userIdentity UserIdentity[]
  organizer    Organizer[]
  createdAt    DateTime       @default(now())
  updateAt     DateTime       @updatedAt
  ActivityLike ActivityLike[]
  orders       Order[]
	tickets      Ticket[]

  @@map("users") // 指定存入db的table name
}

model UserIdentity {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id])
  provider   String
  providerId String
  createdAt  DateTime @default(now())

  @@map("user_identities")
}

model Organizer {
  id              Int        @id @default(autoincrement())
  userId          Int
  email           String     @unique
  name            String?
  avatar          String?
  cover           String?
  introduction    String?
  phoneNumber     String?
  countryCode     String?
  ext             String?
  officialSiteUrl String?
  localeId        Int?
  currencyId      Int?
  createdAt       DateTime   @default(now())
  updateAt        DateTime   @updatedAt
  deletedAt       DateTime?
  user            User       @relation(fields: [userId], references: [id])
  locale          Locale?    @relation(fields: [localeId], references: [id])
  currency        Currency?  @relation(fields: [currencyId], references: [id])
  Activity        Activity[]

  @@map("organizers")
}

model Locale {
  id        Int         @id @default(autoincrement())
  name      String
  code      String
  Organizer Organizer[]

  @@map("locales")
}

model Currency {
  id        Int         @id @default(autoincrement())
  name      String
  code      String
  Organizer Organizer[]

  @@map("currencies")
}

model Activity {
  id               Int                @id @default(autoincrement())
  organizerId      Int
  cover            String?
  title            String
  location         String?
  startTime        DateTime
  endTime          DateTime
  isOnline         Boolean
  tags             String?
  status           ActivityStatus     @default(draft)
  descriptionMd    String?
  viewCount        Int                @default(0)
  createdAt        DateTime           @default(now())
  updateAt         DateTime           @updatedAt
  summary          String?
  notes            String?
  livestreamUrl    String?
  organizer        Organizer          @relation(fields: [organizerId], references: [id])
  ActivityCategory ActivityCategory[]
  ActivityLike     ActivityLike[]
  orders           Order[]
	tickets          Ticket[]
  ticketType       TicketType[]

  @@map("activities")
}

model Category {
  id         Int                @id @default(autoincrement())
  name       String
  image      String?
  icon       String?
  activities ActivityCategory[] // 多對多關聯表

  @@map("categories")
}

model ActivityCategory {
  activityId Int
  categoryId Int

  activity Activity @relation(fields: [activityId], references: [id])
  category Category @relation(fields: [categoryId], references: [id])

  @@id([activityId, categoryId]) // Composite Primary Key
  @@map("activity_categories")
}

model ActivityLike {
  activityId Int
  userId     Int
  createdAt  DateTime @default(now())
  activity   Activity @relation(fields: [activityId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@id(name: "activityLikeId", [activityId, userId])
  @@map("activity_likes")
}

model Order {
  id                         String      @id
  userId                     Int
  user                       User        @relation(fields: [userId], references: [id])
  paidExpiredAt              DateTime    @default(dbgenerated("now() + interval '10 minutes'"))
  paidAt                     DateTime?
  status                     OrderStatus @default(PENDING)
  createdAt                  DateTime    @default(now())
  updatedAt                  DateTime?   @updatedAt
  activityId                 Int
  activity                   Activity    @relation(fields: [activityId], references: [id])
  invoiceAddress             String?
  invoiceTitle               String?
  invoiceTaxId               String?
  invoiceReceiverName        String?
  invoiceReceiverPhoneNumber String?
  invoiceReceiverEmail       String?
  invoiceCarrier             String?
  invoiceType                InvoiceType @default(B2C)
	tickets 									Ticket[]

  @@map("orders")
}

model Ticket {
	id String @id
	ticketTypeId Int
	ticketType TicketType @relation(fields: [ticketTypeId], references: [id])
	activityId Int
	activity Activity @relation(fields: [activityId], references: [id])
	orderId String
	order Order @relation(fields: [orderId], references: [id])
	qrCodeToken String @unique
	checkInAt DateTime?
	status String @default("unused")
	assignedUserId Int?
	assignedUser User? @relation(fields: [assignedUserId], references: [id])
	assignedEmail String @unique
	assignedName String
	refundDeadline DateTime
	createdAt DateTime @default(now())
	updateAt DateTime? @updatedAt

	@@map("tickets")
}

model TicketType {
	id Int @id @default(autoincrement())
	activityId Int
	activity Activity @relation(fields: [activityId], references: [id])
	name String
	price Int
	totalQuantity Int
	remainingQuantity Int
	description String?
	startTime DateTime
	endTime DateTime
	saleStartAt DateTime?
	saleEndAt DateTime?
	isActive Boolean @default(true)
	createdAt DateTime @default(now())
	updateAt DateTime? @updatedAt
	tickets Ticket[]

	@@map("ticket_types")
}
